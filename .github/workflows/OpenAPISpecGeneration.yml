name: Sync OpenAPI to Frontend

on:
  push:
    branches:
      - master  # adjust to your default branch
  workflow_dispatch:  # allows manual trigger

jobs:
  sync-openapi:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Nucleus
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'  # adjust to your .NET version

      - name: Build Nucleus to generate OpenAPI spec
        run: dotnet build --configuration Release

      - name: Verify OpenAPI spec exists
        run: |
          if [ ! -f Nucleus/bin/Release/net9.0/Nucleus.json ]; then
            echo "Error: Nucleus/bin/Release/net9.0/Nucleus.json not found after build"
            exit 1
          fi

      - name: Checkout Frontend Repo
        uses: actions/checkout@v4
        with:
          repository: PlusCosmic/plus-cosmic-dev
          token: ${{ secrets.FRONTEND_REPO_TOKEN }}
          path: plus-cosmic-dev

      - name: Copy OpenAPI Spec
        run: |
          cp Nucleus/bin/Release/net9.0/Nucleus.json plus-cosmic-dev/packages/nucleus-api-client/Nucleus.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Install dependencies
        working-directory: plus-cosmic-dev
        run: |
          # Install from workspace root for proper monorepo dependency resolution
          pnpm install --config.ignore-scripts=false

      - name: Regenerate API Client
        working-directory: plus-cosmic-dev/packages/nucleus-api-client
        run: |
          # Clear src directory for clean start
          rm -rf src
          mkdir -p src

          # Generate TypeScript client using the installed package
          pnpm exec openapi-generator-cli generate -i Nucleus.json -g typescript-fetch -o src --additional-properties=supportsES6=true

          # Build the package
          pnpm run build

      - name: Commit and push changes
        id: commit_changes
        working-directory: plus-cosmic-dev
        env:
          GITHUB_TOKEN: ${{ secrets.FRONTEND_REPO_TOKEN }}
          BRANCH_NAME: api-sync/nucleus-${{ github.sha }}
          COMMIT_MESSAGE: 'chore: update Nucleus API client from ${{ github.sha }}'
        run: |
          # Check if there are changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes detected in generated client"
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Configure git with authentication
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Configure git to use the token for authentication
          git config url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"

          # Delete branch if it exists locally from a previous failed run
          git branch -D "$BRANCH_NAME" 2>/dev/null || true

          # Create and switch to new branch
          git checkout -b "$BRANCH_NAME"

          # Stage and commit changes (force add generated files even if in .gitignore)
          git add -f packages/nucleus-api-client/Nucleus.json
          git add -f packages/nucleus-api-client/src/
          git add packages/nucleus-api-client/dist/ 2>/dev/null || true
          git add packages/nucleus-api-client/package.json 2>/dev/null || true

          # Check if anything was actually staged
          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è No files were staged for commit (files may be gitignored)"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          git commit -m "$COMMIT_MESSAGE"

          # Push to frontend repo (force push since this is an automated branch)
          git push -u origin "$BRANCH_NAME" --force

      - name: Create or Update Pull Request
        if: steps.commit_changes.outputs.has_changes == 'true'
        working-directory: plus-cosmic-dev
        env:
          GH_TOKEN: ${{ secrets.FRONTEND_REPO_TOKEN }}
          BRANCH_NAME: api-sync/nucleus-${{ github.sha }}
          SOURCE_REPO: ${{ github.repository }}
          SOURCE_SHA: ${{ github.sha }}
          SOURCE_BRANCH: ${{ github.ref_name }}
          TRIGGER_MESSAGE: ${{ github.event.head_commit.message }}
          PR_BODY: |
            ## ü§ñ Automated API Client Update

            This PR updates the \`nucleus-api-client\` package based on OpenAPI spec changes from Nucleus.

            ### Changes
            - Updated \`Nucleus.json\` OpenAPI specification
            - Regenerated TypeScript client in \`packages/nucleus-api-client/src\`
            - Rebuilt the package

            ### Source
            - **Repository:** $SOURCE_REPO
            - **Commit:** $SOURCE_SHA
            - **Branch:** $SOURCE_BRANCH
            - **Triggered by:** $TRIGGER_MESSAGE

            ### Next Steps
            1. Review the generated changes
            2. Ensure tests pass
            3. Merge when ready

            ---

            _This PR was automatically created by the Nucleus OpenAPI sync workflow._
        run: |
          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "üìù Updating existing PR #$EXISTING_PR"
            gh pr edit "$EXISTING_PR" \
              --title "Update Nucleus API Client" \
              --body "$PR_BODY"
          else
            echo "‚ú® Creating new PR"
            gh pr create \
              --title "Update Nucleus API Client" \
              --body "$PR_BODY" \
              --label "automated,api-client,nucleus" \
              --head "$BRANCH_NAME" \
              --base master
          fi

      - name: Output result
        if: always()
        run: |
          if [ "${{ steps.commit_changes.outputs.has_changes }}" == "true" ]; then
            echo "‚úÖ Pull request created successfully"
          else
            echo "‚ÑπÔ∏è No changes to API client, skipping PR creation"
          fi
