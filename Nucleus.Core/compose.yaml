services:
  nucleus:
    build:
      context: ..
      dockerfile: Nucleus.Core/Dockerfile
    container_name: nucleus
    restart: unless-stopped
    expose:
      - "8080"
    environment:
      # Core ASP.NET
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: ${ASPNETCORE_FORWARDEDHEADERS_ENABLED}
      ASPNETCORE_URLS: ${ASPNETCORE_URLS}
      # Database
      DatabaseConnectionString: ${DatabaseConnectionString}
      RedisConnectionString: ${RedisConnectionString:-}
      # Discord
      DiscordClientId: ${DiscordClientId}
      DiscordClientSecret: ${DiscordClientSecret}
      DiscordBotToken: ${DiscordBotToken:-}
      # URLs
      BackendAddress: ${BackendAddress}
      # Bunny CDN
      BunnyLibraryId: ${BunnyLibraryId:-}
      BunnyAccessKey: ${BunnyAccessKey:-}
      # Apex Legends
      ApexLegendsApiKey: ${ApexLegendsApiKey:-}
      # FFmpeg (maps FFmpegSharedPath from .env to FFmpegOutputPath used by code)
      FFmpegOutputPath: ${FFmpegSharedPath:-/tmp/ffmpeg-downloads}
      # Backblaze B2 backup
      Backblaze__KeyId: ${Backblaze__KeyId:-}
      Backblaze__ApplicationKey: ${Backblaze__ApplicationKey:-}
      Backblaze__BucketName: ${Backblaze__BucketName:-}
      Backblaze__Endpoint: ${Backblaze__Endpoint:-}
      Backblaze__BucketPrefix: ${Backblaze__BucketPrefix:-minecraft-backups/}
      Backblaze__SyncIntervalHours: ${Backblaze__SyncIntervalHours:-1}
      #IGDB
      IgdbClientId: ${IgdbClientId}
      IgdbClientSecret: ${IgdbClientSecret}
    networks:
      - dokploy-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
networks:
  dokploy-network:
    external: true
