services:
  nucleus-minecraft:
    build:
      context: ..
      dockerfile: Nucleus.Minecraft/Dockerfile
    container_name: nucleus-minecraft
    restart: unless-stopped
    expose:
      - "8080"
    environment:
      # Core ASP.NET
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: ${ASPNETCORE_FORWARDEDHEADERS_ENABLED}
      ASPNETCORE_URLS: ${ASPNETCORE_URLS}
      # Database
      DatabaseConnectionString: ${DatabaseConnectionString}
      # Discord
      DiscordClientId: ${DiscordClientId}
      DiscordClientSecret: ${DiscordClientSecret}
      # Docker integration
      Docker__ProxyHost: tcp://socket-proxy:2375
      Docker__NetworkName: dokploy-network
      # Backblaze B2 backup
      Backblaze__KeyId: ${Backblaze__KeyId:-}
      Backblaze__ApplicationKey: ${Backblaze__ApplicationKey:-}
      Backblaze__BucketName: ${Backblaze__BucketName:-}
      Backblaze__Endpoint: ${Backblaze__Endpoint:-}
      Backblaze__BucketPrefix: ${Backblaze__BucketPrefix:-minecraft-backups/}
      Backblaze__SyncIntervalHours: ${Backblaze__SyncIntervalHours:-1}
    volumes:
      # Minecraft server data - maps to PersistenceLocation paths
      - /srv/minecraft-servers:/minecraft-servers:rw
    networks:
      - dokploy-network
    depends_on:
      socket-proxy:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: nucleus-minecraft-socket-proxy
    restart: unless-stopped
    environment:
      # Container operations (list, create, start, stop, remove, inspect, stats)
      CONTAINERS: 1
      POST: 1
      DELETE: 1
      # Image operations (list, inspect, pull)
      IMAGES: 1
      # Volume operations (create, remove)
      VOLUMES: 1
      # Disabled for security
      AUTH: 0
      SECRETS: 0
      SWARM: 0
      NETWORKS: 0
      SERVICES: 0
      TASKS: 0
      BUILD: 0
      COMMIT: 0
      CONFIGS: 0
      DISTRIBUTION: 0
      EXEC: 0
      GRPC: 0
      INFO: 0
      NODES: 0
      PLUGINS: 0
      SYSTEM: 0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true
