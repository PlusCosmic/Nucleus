services:
  nucleus:
    build:
      context: .
      dockerfile: Nucleus/Dockerfile
    container_name: nucleus
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      # Database
      DatabaseConnectionString: "Host=postgres;Database=nucleus;Username=nucleus;Password=${POSTGRES_PASSWORD}"
      # Discord OAuth
      DiscordClientId: ${DISCORD_CLIENT_ID}
      DiscordClientSecret: ${DISCORD_CLIENT_SECRET}
      DiscordBotToken: ${DISCORD_BOT_TOKEN:-}
      DISCORD_ADMIN_ROLE_ID: ${DISCORD_ADMIN_ROLE_ID:-}
      DISCORD_EDITOR_ROLE_ID: ${DISCORD_EDITOR_ROLE_ID:-}
      # URLs
      FrontendOrigin: ${FRONTEND_ORIGIN}
      BackendAddress: ${BACKEND_ADDRESS}
      # Bunny CDN
      BunnyLibraryId: ${BUNNY_LIBRARY_ID:-}
      BunnyAccessKey: ${BUNNY_ACCESS_KEY:-}
      BunnyWebhookSecret: ${BUNNY_WEBHOOK_SECRET:-}
      # Apex Legends
      ApexLegendsApiKey: ${APEX_LEGENDS_API_KEY:-}
      # FFmpeg
      FFmpegOutputPath: /tmp/ffmpeg-downloads
      # Docker integration for Minecraft
      Docker__ProxyHost: tcp://socket-proxy:2375
      Docker__NetworkName: nucleus_internal
      # CurseForge (for modded servers)
      CurseforgeApiKey: ${CURSEFORGE_API_KEY:-}
      # Backblaze B2 backup (optional)
      Backblaze__KeyId: ${BACKBLAZE_KEY_ID:-}
      Backblaze__ApplicationKey: ${BACKBLAZE_APPLICATION_KEY:-}
      Backblaze__BucketName: ${BACKBLAZE_BUCKET_NAME:-}
      Backblaze__Endpoint: ${BACKBLAZE_ENDPOINT:-}
      Backblaze__BucketPrefix: ${BACKBLAZE_BUCKET_PREFIX:-minecraft-backups/}
      Backblaze__LocalRetentionCount: ${BACKBLAZE_LOCAL_RETENTION_COUNT:-3}
      Backblaze__SyncIntervalHours: ${BACKBLAZE_SYNC_INTERVAL_HOURS:-1}
    volumes:
      # Minecraft server data - maps to PersistenceLocation paths
      - /srv/minecraft-servers:/minecraft-servers:rw
    networks:
      - nucleus_internal
    depends_on:
      postgres:
        condition: service_healthy
      socket-proxy:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  postgres:
    image: postgres:16-alpine
    container_name: nucleus-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: nucleus
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: nucleus
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - nucleus_internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nucleus -d nucleus"]
      interval: 10s
      timeout: 5s
      retries: 5

  socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: nucleus-socket-proxy
    restart: unless-stopped
    environment:
      # Container operations (list, create, start, stop, remove, inspect, stats)
      CONTAINERS: 1
      POST: 1
      DELETE: 1
      # Image operations (list, inspect, pull)
      IMAGES: 1
      # Volume operations (create, remove)
      VOLUMES: 1
      # Disabled for security
      AUTH: 0
      SECRETS: 0
      SWARM: 0
      NETWORKS: 0
      SERVICES: 0
      TASKS: 0
      BUILD: 0
      COMMIT: 0
      CONFIGS: 0
      DISTRIBUTION: 0
      EXEC: 0
      GRPC: 0
      INFO: 0
      NODES: 0
      PLUGINS: 0
      SYSTEM: 0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - nucleus_internal

networks:
  nucleus_internal:
    name: nucleus_internal
    driver: bridge

volumes:
  postgres_data:
